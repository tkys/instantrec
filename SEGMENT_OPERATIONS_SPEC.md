# セグメント操作機能 要件定義書

## 概要
InstantRecアプリにおけるタイムスタンプ付き文字起こしデータを活用したセグメント操作機能の詳細仕様。

## 1. 基本セグメント操作

### 1.1 セグメント分割・結合
- **分割機能**
  - 任意の時点でセグメントを分割
  - UI: タイムライン上の分割ボタン
  - ショートカット: ダブルタップで分割
  - 結果: 新しいセグメント境界を作成

- **結合機能**
  - 隣接する複数セグメントを結合
  - UI: セグメント選択→結合ボタン
  - 制限: 連続するセグメントのみ結合可能
  - 結果: 単一セグメントに統合、テキストは空白区切りで結合

### 1.2 セグメント編集
- **テキスト編集**
  - セグメント単位での文字起こし修正
  - UI: セグメントカード内のインライン編集
  - 保存: 自動保存（編集完了時）
  - 履歴: オリジナルテキスト保持

- **タイムスタンプ編集**
  - 開始・終了時間の微調整
  - UI: ドラッグ操作またはテキストフィールド
  - 制限: 前後セグメントとの重複チェック
  - 精度: 0.1秒単位

## 2. セグメント表示・ナビゲーション

### 2.1 表示モード
1. **リストモード**: 縦スクロール、セグメント番号順
2. **タイムラインモード**: 横スクロール、時系列表示
3. **カードモード**: グリッド表示、サムネイル風
4. **フォーカスモード**: 1セグメントのみ大きく表示

### 2.2 ナビゲーション
- **セグメント間移動**
  - 前/次セグメントボタン
  - スワイプジェスチャー
  - キーボードショートカット (←/→)

- **ジャンプ機能**
  - セグメント番号指定ジャンプ
  - 時間指定ジャンプ
  - 検索結果からのジャンプ

## 3. セグメント検索・フィルタリング

### 3.1 テキスト検索
- **全文検索**: 全セグメントのテキストを対象
- **ハイライト表示**: 検索語句をマークアップ
- **件数表示**: マッチしたセグメント数
- **ナビゲーション**: 検索結果間の移動

### 3.2 フィルタリング
- **時間範囲フィルタ**
  - 開始時間〜終了時間でフィルタ
  - UI: 時間範囲スライダー

- **セグメント長フィルタ**
  - 短い/長いセグメントのみ表示
  - 用途: 無音区間や長文の特定

- **編集状態フィルタ**
  - 編集済み/未編集セグメントのみ表示
  - 用途: 校正作業の効率化

## 4. セグメント品質管理

### 4.1 品質チェック
- **無音セグメント検出**
  - テキストが空または記号のみのセグメント
  - 自動削除またはマーク表示の選択

- **短すぎるセグメント**
  - 0.5秒未満のセグメントを警告
  - 前後セグメントとの自動結合提案

- **重複テキスト検出**
  - 同一または類似テキストのセグメント発見
  - 重複箇所のハイライト表示

### 4.2 一括操作
- **一括削除**: 選択したセグメントの削除
- **一括編集**: 複数セグメントのテキスト置換
- **一括移動**: セグメント順序の入れ替え

## 5. エクスポート・共有機能

### 5.1 セグメント単位エクスポート
- **選択エクスポート**: 指定セグメントのみ
- **フォーマット**: テキスト、SRT、VTT、JSON
- **範囲指定**: 時間範囲またはセグメント番号範囲

### 5.2 共有機能
- **部分共有**: 特定セグメントのテキスト共有
- **リンク共有**: 該当セグメントへの直接リンク
- **スクリーンショット**: セグメント表示の画像化

## 6. 実装優先度

### P0 (必須・即時実装)
- [x] 基本的なタイムスタンプ連動再生
- [x] セグメント表示の4モード対応
- [ ] セグメント検索機能
- [ ] セグメント単位テキスト編集

### P1 (重要・次期実装)
- [ ] セグメント分割・結合
- [ ] 品質チェック機能
- [ ] 一括操作（削除・編集）
- [ ] 選択エクスポート

### P2 (価値追加・将来実装)
- [ ] タイムスタンプ手動編集
- [ ] セグメント順序入れ替え
- [ ] 高度なフィルタリング
- [ ] 共有リンク機能

## 7. 技術仕様

### 7.1 データ構造
```swift
struct TranscriptionSegment {
    let id: UUID
    var startTime: TimeInterval
    var endTime: TimeInterval
    var text: String
    var originalText: String?
    var confidence: Float?
    var isEdited: Bool
    var metadata: [String: Any]?
}
```

### 7.2 UI コンポーネント
- `SegmentListView`: セグメント一覧表示
- `SegmentEditView`: 個別セグメント編集
- `SegmentTimelineView`: タイムライン表示
- `SegmentSearchView`: 検索・フィルタUI

### 7.3 操作インターフェース
- タップ: セグメント選択・再生開始
- ロングプレス: コンテキストメニュー表示
- スワイプ: セグメント間移動
- ピンチ: タイムライン拡大縮小

## 8. ユーザビリティ配慮

### 8.1 アクセシビリティ
- VoiceOver対応: セグメント情報の音声読み上げ
- コントラスト: 高コントラストモード対応
- フォントサイズ: Dynamic Type対応

### 8.2 エラーハンドリング
- セグメント操作失敗時の自動復旧
- 編集内容の自動保存・復元
- ネットワークエラー時のローカル操作継続

### 8.3 パフォーマンス
- 仮想化: 大量セグメントの効率的表示
- 遅延読み込み: 必要セグメントのみ表示
- メモリ管理: 不要セグメントデータの解放

---

この仕様に基づいて段階的な実装を進めていきます。