# InstantRec Google Drive 同期の仕組み

## 📋 アップロードのタイミング

### ✅ アップロードが実行される条件
1. **録音完了時** - 録音停止ボタンを押した瞬間
2. **Google Drive認証済み** - 設定画面で連携完了している
3. **ファイル保存成功** - ローカルストレージへの保存が完了

### ⏰ 具体的な流れ
```
録音停止 → ファイル保存 → SwiftData保存 → アップロードキューに追加 → Google Driveアップロード
```

## 🔄 アップロード回数と重複防止

### 📤 1回のみアップロード
- **同じファイルは1回だけ**アップロードされます
- `CloudSyncStatus`で状態管理：
  - `notSynced` → `pending` → `uploading` → `synced`
  - `synced`状態のファイルは再アップロードされません

### 🛡️ 重複防止の仕組み
1. **SwiftDataの状態管理**: 各録音ファイルの同期状態を記録
2. **キューの重複チェック**: 既にキューにあるファイルは追加されない
3. **アップロード済み判定**: `synced`状態のファイルはスキップ

## 📱 オフライン・オンライン対応

### 🌐 ネットワーク接続時
- **即座にアップロード開始**
- リアルタイムで進捗表示
- 成功時に`synced`状態に更新

### 📴 オフライン時
- **アップロードキューに保存**
- `pending`状態で待機
- ネットワーク復旧時に自動実行

### 🔁 リトライ機能
- **エラー時**: `error`状態に変更
- **自動リトライ**: アプリ再起動時やネットワーク復旧時
- **手動リトライ**: 設定画面から再試行可能

## ⚙️ アップロード設定

### 📂 保存先
- **Google Drive専用フォルダ**: "InstantRec Recordings"
- **自動作成**: 初回アップロード時にフォルダ作成
- **ファイル形式**: M4A音声ファイル

### 🔐 セキュリティ
- **OAuth 2.0認証**: Googleアカウントで安全にログイン
- **最小権限**: ファイル作成・読み取りのみ（削除権限なし）
- **認証永続化**: 一度ログインすれば再認証不要

## 📊 同期状態の確認方法

### 🏠 録音一覧画面
- **アイコンで状態表示**:
  - ⏰ `pending` - 時計マーク（オレンジ）
  - ☁️ `uploading` - アップロード中（青）
  - ✅ `synced` - チェックマーク（緑）
  - ❌ `error` - エラーマーク（赤）

### ⚙️ 設定画面
- **連携アカウント表示**: メールアドレスと名前
- **アップロード状況**: 進行中・待機中の件数
- **接続/切断ボタン**: いつでも連携ON/OFF可能

## 🚨 注意事項

### ⚠️ アップロード条件
- **Google Drive容量**: 容量不足時はアップロード失敗
- **ファイルサイズ制限**: 特に制限なし（Google Driveの上限まで）
- **同時アップロード数**: 1件ずつ順次処理（安定性重視）

### 🔄 再アップロードしたい場合
現在は1回のみですが、今後の更新で以下を検討：
- 手動再アップロード機能
- ファイル更新時の再同期
- 同期エラー時のワンタップリトライ